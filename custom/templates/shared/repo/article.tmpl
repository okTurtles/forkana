{{define "shared/repo/article"}}
<div class="history-view-section history-view-section--article" data-view="article" {{if not .IsArticleView}}hidden{{end}}>
    <div class="ui tw-mt-10" id="article-view-root" data-article-mode="{{if .ArticleMode}}{{.ArticleMode}}{{else}}read{{end}}">
        {{if .IsSubjectContext}}
            <div class="ui info message" id="article-guidance" style="display:none">
                {{svg "octicon-info" 16}}
                <span class="tw-ml-2">Select an article in Bubble view or Table view to open its Article page.</span>
            </div>
        {{end}}
        <div class="ui message" aria-live="polite" data-role="article-empty" {{if .ReadmeRequested}}hidden{{end}}>
            {{svg "octicon-info" 16}}
            <span class="tw-ml-2">Please select an article in bubble or table view.</span>
        </div>
        <div data-role="article-content" {{if not .ReadmeRequested}}hidden{{end}}>
        {{if .ReadmeError}}
            <div class="ui error message">
                {{.ReadmeError}}
            </div>
        {{else}}
            <div class="ui active inline loader tw-mt-4" data-role="article-loader" hidden></div>
            <div class="ui error message tw-mt-4" data-role="article-error" hidden>
                <p data-role="article-error-text"></p>
            </div>
            <div class="tw-flex tw-items-center tw-gap-2">
                <span class="pill">
                    {{svg "octicon-person" 16 "tw-mr-1"}}
                    {{.ReadmeContributorCount}} {{if eq .ReadmeContributorCount 1}}contributor{{else}}contributors{{end}}
                </span>
                {{if and .ReadmeLastCommit .ReadmeLastCommit.Committer}}
                    <span class="pill">
                        {{svg "octicon-sync" 16 "tw-mr-1"}}
                        Updated {{DateUtils.TimeSince .ReadmeLastCommit.Committer.When}}
                    </span>
                {{end}}
            </div>
            <div class="tw-flex tw-items-center tw-gap-4" id="article-tabs">
                <div class="ui top attached tabular menu tw-my-10 tw-gap-1">
                    <a class="{{if .IsArticleModeRead}}active {{end}}item"
                        href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name (.Repository.GetSubject ctx)) "view" "article" "mode" "read"}}"
                        data-article-tab="read">
                        {{svg "octicon-book" 16}} Read
                    </a>
                    <a class="{{if .IsArticleModeEdit}}active {{end}}item"
                        href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name (.Repository.GetSubject ctx)) "view" "article" "mode" "edit"}}"
                        data-article-tab="edit">
                        {{svg "octicon-pencil" 16}} Edit
                    </a>
                    <a class="{{if .IsArticleModeHistory}}active {{end}}item"
                        href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name (.Repository.GetSubject ctx)) "view" "article" "mode" "history"}}"
                        data-article-tab="history">
                        {{svg "octicon-history" 16}} History
                    </a>
                    <div class="tw-flex tw-items-center tw-gap-2 tw-ml-auto">
                        {{if .IsArticleModeRead}}
                            <div class="tw-flex">
                                {{template "repo/watch_unwatch" .}}
                            </div>
                            <div class="ui icon top left pointing dropdown button mini tw-px-3">
                                {{svg "octicon-kebab-horizontal" 14}}
                                <div class="menu">
                                    <div class="item">Something</div>
                                </div>
                            </div>
                        {{end}}
                        {{if .IsArticleModeEdit}}
                            <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
                                <div class="tw-flex tw-items-center tw-gap-2">
                                    {{if .IsSigned}}
                                        {{if .IsRepoOwner}}
                                            {{/* User can edit directly - show simple submit button */}}
                                            <button type="button" id="submit-changes-button" class="ui primary button" data-fork-and-edit="false">
                                                {{svg "octicon-check" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.submit_changes"}}
                                            </button>
                                        {{else if .HasOwnRepoForSubject}}
                                            {{/* User owns an independent article for this subject (not a fork of this repo) */}}
                                            {{/* They cannot submit change requests here - redirect to their own article */}}
                                            <a href="{{.OwnRepoForSubject.Link}}?view=article&mode=edit" class="ui primary button">
                                                {{svg "octicon-pencil" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.edit_your_article"}}
                                            </a>
                                        {{else if .HasExistingFork}}
                                            {{/* User has an existing fork of this repo - show both options */}}
                                            <a href="{{.ExistingFork.Link}}?view=article&mode=edit" class="ui secondary button">
                                                {{svg "octicon-repo-forked" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.edit_in_your_fork"}}
                                            </a>
                                            <button type="button" id="pre-submit-changes-button" class="ui primary button"
                                                data-tooltip-content="{{ctx.Locale.Tr "repo.editor.submit_changes_tooltip"}}">
                                                {{svg "octicon-git-pull-request" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.submit_changes"}}
                                            </button>
                                        {{else if .NeedsFork}}
                                            {{/* User needs to create a fork - show fork-and-submit button */}}
                                            <button type="button" id="fork-article-button" class="ui secondary button"
                                                data-fork-and-edit="true"
                                                data-tooltip-content="{{ctx.Locale.Tr "repo.fork_article_confirm_body"}}"
                                                data-fork-confirm-title="{{ctx.Locale.Tr "repo.fork_article_confirm_title"}}"
                                                data-fork-confirm-body="{{ctx.Locale.Tr "repo.fork_article_confirm_body"}}"
                                                data-fork-confirm-yes="{{ctx.Locale.Tr "repo.fork_article_confirm_yes"}}"
                                                data-fork-confirm-cancel="{{ctx.Locale.Tr "repo.fork_article_confirm_cancel"}}">
                                                {{svg "octicon-repo-forked" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.fork_article"}}
                                            </button>
                                            {{/* Submit Change Request - opens modal for title/description, then creates branch + commit + PR */}}
                                            <button type="button" id="pre-submit-changes-button" class="ui primary button"
                                                data-tooltip-content="{{ctx.Locale.Tr "repo.editor.submit_changes_tooltip"}}">
                                                {{svg "octicon-git-pull-request" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.submit_changes"}}
                                            </button>
                                        {{else}}
                                            {{/* Fallback - show disabled button */}}
                                            <button type="button" class="ui primary button disabled">
                                                {{svg "octicon-check" 16 "tw-mr-1"}}
                                                {{ctx.Locale.Tr "repo.editor.submit_changes"}}
                                            </button>
                                        {{end}}
                                    {{else}}
                                        <button type="button" class="ui primary button disabled">
                                            {{svg "octicon-check" 16 "tw-mr-1"}}
                                            {{ctx.Locale.Tr "repo.editor.sign_in_to_edit"}}
                                        </button>
                                    {{end}}
                                </div>
                            </div>
                        {{end}}
                        {{if .IsArticleModeHistory}}
                            <div class="ui icon top left pointing dropdown button mini tw-px-3">
                                {{svg "octicon-kebab-horizontal" 14}}
                                <div class="menu">
                                    <div class="item">Something</div>
                                </div>
                            </div>
                        {{end}}
                    </div>
                </div>
            </div>
            {{template "shared/repo/read" .}}
            {{template "shared/repo/edit" .}}
            {{template "shared/repo/history" .}}
        {{end}}
        </div>
    </div>
</div>
{{end}}
